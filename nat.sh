#!/bin/sh

ipset -! -N tocn iphash

iptables -t nat -D PREROUTING -p tcp -m set --match-set tocn dst -j REDIRECT --to-port 1080
iptables -t nat -D OUTPUT -p tcp -m set --match-set tocn dst -j REDIRECT --to-port 1080
iptables -t nat -A PREROUTING -p tcp -m set --match-set tocn dst -j REDIRECT --to-port 1080
iptables -t nat -A OUTPUT -p tcp -m set --match-set tocn dst -j REDIRECT --to-port 1080

while read line ; do ipset add tocn $line ;done <<-EOF
101.227.139.217
101.227.169.200
103.65.41.125
103.65.41.126
103.7.30.79
103.7.30.89
103.7.31.186
106.11.186.4
106.11.209.2
106.11.47.19
106.11.47.20
111.13.127.46
111.206.208.163
111.206.208.164
111.206.208.166
111.206.208.36
111.206.208.37
111.206.208.38
111.206.208.61
111.206.208.62
111.206.211.129
111.206.211.130
111.206.211.131
111.206.211.145
111.206.211.146
111.206.211.147
111.206.211.148
115.182.200.50
115.182.200.51
115.182.200.52
115.182.200.53
115.182.200.54
115.182.63.51
115.182.63.93
117.185.116.152
118.244.244.124
120.92.96.181
122.72.82.31
123.125.89.101
123.125.89.102
123.125.89.103
123.125.89.157
123.125.89.159
123.125.89.6
123.126.32.134
123.126.99.39
123.126.99.57
123.59.122.104
123.59.122.75
123.59.122.75                
123.59.122.76
123.59.122.77
14.152.77.22
14.152.77.25
14.152.77.26
14.152.77.32
14.18.245.250
140.207.69.99
163.177.90.61
180.153.225.136
182.16.230.98
182.254.11.174
182.254.116.117
182.254.34.151
182.254.4.234
183.192.192.139
183.232.119.198
183.232.126.23
183.232.229.21
183.232.229.22
183.232.229.25
183.232.229.32
203.205.151.23
210.129.145.150
211.151.157.15
211.151.158.155
211.151.50.10
220.181.153.113
220.181.154.137
220.181.185.150
220.249.243.70
223.167.82.139
36.110.222.105
36.110.222.119
36.110.222.146
36.110.222.156
59.37.96.220
61.135.196.99
157.185.175.102
45.76.187.134
47.246.24.227
172.67.182.77
223.252.199.69
17.253.144.10
142.250.217.68
35.186.220.184
39.105.63.80
39.105.175.128
45.254.48.1
47.100.127.239
59.111.160.195
59.111.160.197
59.111.181.35
59.111.181.38
59.111.181.60
101.71.154.241
103.126.92.132
103.126.92.133
112.13.119.17
112.13.119.18
112.13.122.1
112.13.122.4
115.236.118.33
115.236.121.1
118.24.63.156
182.92.170.253
193.112.159.225
223.252.199.66
223.252.199.67
EOF

ipset -! -N rtocn hash:net
ipset add rtocn 106.11.1.1/16

iptables -t nat -D PREROUTING -p tcp -m set --match-set rtocn dst -j REDIRECT --to-port 1080
iptables -t nat -D OUTPUT -p tcp -m set --match-set rtocn dst -j REDIRECT --to-port 1080
iptables -t nat -A PREROUTING -p tcp -m set --match-set rtocn dst -j REDIRECT --to-port 1080
iptables -t nat -A OUTPUT -p tcp -m set --match-set rtocn dst -j REDIRECT --to-port 1080

/etc/init.d/dnsmasq restart
